// (eval env e) -> evaluation of e in env, or NIL if error
// only user of the stack vm abstraction!
(EVALEVAL)
    // prepare 4 local variables, initialised to 0
	@SP
	M=M+1
	A=M-1
	M=0
	@SP
	M=M+1
	A=M-1
	M=0
	@SP
	M=M+1
	A=M-1
	M=0
	@SP
	M=M+1
	A=M-1
	M=0
(EVALSTART)
    @SP
    D=M
    @0x07ff         // end of stack
    D=D-A
    @SYSSTACKOVERFLOW
    D;JGE           // if @SP - 0x07ff >= 0 -> stack overflow
    @FREE
    D=M
    @0x3fff         // end of heap
    D=D-A
    @SYSHEAPOVERFLOW
    D;JGE           // if @FREE - 0x3fff >= 0 -> heap overflow
    @ARG
    D=M
    @6              // ARG+4 = start of local stack
    A=D+A           // so this is local 2
    M=0             // reset numargs to 0
    @ARG
    A=M
    ISPROC
    @EVALSELF
    !D;JEQ          // if (ISPROC e) then goto evalself
    @ARG
    A=M
    ISSYMB
    @EVALSYMBOL
    !D;JEQ          // if (ISSYMB e) then goto evalsymbol
    @ARG
    A=M
    ISPRIM
    @EVALSELF
    !D;JEQ          // if (ISPRIM e) then goto evalself
(EVALPAIR)          // fallthrough
    @ENV
    A=M
    D=M
	@SP
	M=M+1
	A=M-1
	M=D
    @ARG
    A=M
    A=M
    MCAR
	@SP
	M=M+1
	A=M-1
	M=D
    @EVALEVAL
    D=A
    @R13
    M=D
    @EVALFIRSTRET
    D=A
    @R15
    M=D
    @SYSCALL
    0;JMP
(EVALFIRSTRET)
    // if return value is not proc
    // -> goto sys.errapplynonproc
    @SP
    A=M-1
    ISPROC
    @SYSERRAPPLYNONPROC
    !D;JNE
    // else, local 1 = evalled proc
    // and goto evalprocedure
    @ARG
    D=M
    @5
    D=D+A
    @R14
    M=D
    @SP
    A=M-1
    D=M
    @R14
    A=M
    M=D             // local 1 = evalled proc
    @EVALPROCEDURE
    0;JMP
(EVALSELF)
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SYSRETURN
	0;JMP
(EVALSYMBOL)
    // construct ( env . ( arg . () ))
    // because we are calling (assq assoclist key)
    // FREE = ( arg . () )
	D=0
	@FREE
	A=M
	SETCDR
	@ARG
    A=M
	D=M
	@FREE
	A=M
	SETCAR
    // FREE+1 = ( env . FREE )
	@FREE
	D=M
	AM=D+1
	SETCDR
    @ENV
    A=M
    D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
    M=M+1
	A=M-1
	M=D         // put on stack as arg
    @EVALASSQRET
    D=A
    @R15
    M=D
    @BUILTINASSQ
    0;JMP
(EVALASSQRET)
    @SP
    A=M-1
    D=M
    @SYSERRSYMBOLNOTFOUND
    D;JEQ           // if assq returns NIL, that means not found
	@SYSRETURN
	0;JMP
(EVALPROCEDURE)
    // TODO can be moved to EVALPAIR, maybe no need to use local 1?
    @5
    D=A
    @ARG
    A=D+M
    ISSPECIAL
    @EVALSPECIAL
    !D;JEQ
(EVALARGS)
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	@SP
	A=M-1
	M=D
	@SP
	A=M-1
	ISEMPTY
	M=D
	@SP
	AM=M-1
	D=M
	@EVALFUNC
	!D;JEQ
	@6
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	M=M+1
	A=M-1
	M=1
	@SP
	AM=M-1
	D=M
	A=A-1
	M=D+M
	@ARG
	D=M
	@6
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@ARG
	A=M
	M=D
	@ENV
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
	@EVALEVAL
	D=A
	@R13
	M=D
	@XXAAAAAJ
	D=A
	@R15
	M=D
	@SYSCALL
	0;JMP
(XXAAAAAJ)
	@EVALARGS
	0;JMP
(EVALFUNC)
	@SP
	M=M+1
	A=M-1
	M=0
(EVALCONSLOOP)
	@SP
	M=M+1
	A=M-1
	M=0
	@6
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	A=A-1
	D=M-D
	M=0
	@XXAAAABA
	D;JNE
	@SP
	A=M-1
	M=!M
(XXAAAABA)
	@SP
	AM=M-1
	D=M
	@EVALAPPLY
	!D;JEQ
	@SP
	AM=M-1
	D=M
	@FREE
	A=M
	SETCDR
	@SP
	A=M-1
	D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
	A=M-1
	M=D
	@6
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	M=M+1
	A=M-1
	M=1
	@SP
	AM=M-1
	D=M
	A=A-1
	M=M-D
	@ARG
	D=M
	@6
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@EVALCONSLOOP
	0;JMP
(EVALAPPLY)
	@ARG
	D=M
	@6
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@SP
	M=M+1
	A=M-1
	M=0
	@ARG
	D=M
	@4
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	ISBUILTIN
	M=D
	@SP
	AM=M-1
	D=M
	@EVALCALLBUILTIN
	!D;JEQ
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@8191
	D=A
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	A=A-1
	M=D&M
	@ARG
	D=M
	@5
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	A=D
	MCAR
	@SP
	A=M-1
	M=D
	@ARG
	D=M
	@7
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
(EVALAPPLYREC)
	@7
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	ISEMPTY
	M=D
	@SP
	AM=M-1
	D=M
	@EVALENDAPPLYREC
	!D;JEQ
	@4
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	M=M+1
	A=M-1
	M=1
	@SP
	AM=M-1
	D=M
	A=A-1
	M=D+M
	@ARG
	D=M
	@4
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@7
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
	@6
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@FREE
	A=M
	SETCDR
	@SP
	A=M-1
	D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
	A=M-1
	M=D
	@6
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	@SP
	A=M-1
	M=D
	@ARG
	D=M
	@6
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@7
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	@SP
	A=M-1
	M=D
	@ARG
	D=M
	@7
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@EVALAPPLYREC
	0;JMP
(EVALENDAPPLYREC)
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
(EVALAPPLYCONSLOOP)
	@SP
	M=M+1
	A=M-1
	M=0
	@4
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	A=A-1
	D=M-D
	M=0
	@XXAAAABB
	D;JNE
	@SP
	A=M-1
	M=!M
(XXAAAABB)
	@SP
	AM=M-1
	D=M
	@EVALAPPLYEND
	!D;JEQ
	@SP
	AM=M-1
	D=M
	@FREE
	A=M
	SETCDR
	@SP
	A=M-1
	D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
	A=M-1
	M=D
	@4
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	M=M+1
	A=M-1
	M=1
	@SP
	AM=M-1
	D=M
	A=A-1
	M=M-D
	@ARG
	D=M
	@4
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@EVALAPPLYCONSLOOP
	0;JMP
(EVALAPPLYEND)
	@SP
	AM=M-1
	D=M
	@ENV
	A=M
	M=D
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	A=D
	MCDR
	A=D
	MCAR
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@ARG
	A=M
	M=D
	@EVALSTART
	0;JMP
(EVALCALLBUILTIN)
	@6
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
		@XXAAAABC
	D=A
	@R15
	M=D
	@SP
	AM=M-1
	D=M
	@0x1fff
	A=D&A
	0;JMP
(XXAAAABC)
	@SYSRETURN
	0;JMP
(EVALSPECIAL)
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@ARG
	A=M
	M=D
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@8191
	D=A
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	A=A-1
	M=D&M
	@ARG
	D=M
	@5
	D=D+A
	@R14
	M=D
	@SP
	AM=M-1
	D=M
	@R14
	A=M
	M=D
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	M=M+1
	A=M-1
	M=0
	@SP
	AM=M-1
	D=M
	A=A-1
	D=M-D
	M=0
	@XXAAAABD
	D;JNE
	@SP
	A=M-1
	M=!M
(XXAAAABD)
	@SP
	AM=M-1
	D=M
	@EVALIF
	!D;JEQ
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	M=M+1
	A=M-1
	M=1
	@SP
	AM=M-1
	D=M
	A=A-1
	D=M-D
	M=0
	@XXAAAABE
	D;JNE
	@SP
	A=M-1
	M=!M
(XXAAAABE)
	@SP
	AM=M-1
	D=M
	@EVALDEFINE
	!D;JEQ
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@2
	D=A
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	A=A-1
	D=M-D
	M=0
	@XXAAAABF
	D;JNE
	@SP
	A=M-1
	M=!M
(XXAAAABF)
	@SP
	AM=M-1
	D=M
	@EVALQUOTE
	!D;JEQ
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@3
	D=A
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	A=A-1
	D=M-D
	M=0
	@XXAAAABG
	D;JNE
	@SP
	A=M-1
	M=!M
(XXAAAABG)
	@SP
	AM=M-1
	D=M
	@EVALSET
	!D;JEQ
	@5
	D=A
	@ARG
	A=D+M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@4
	D=A
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	A=A-1
	D=M-D
	M=0
	@XXAAAABH
	D;JNE
	@SP
	A=M-1
	M=!M
(XXAAAABH)
	@SP
	AM=M-1
	D=M
	@EVALLAMBDA
	!D;JEQ
	@SYSERRUNKNOWNBUILTIN
	0;JMP
(EVALIF)
	@ENV
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
	@EVALEVAL
	D=A
	@R13
	M=D
	@XXAAAABI
	D=A
	@R15
	M=D
	@SYSCALL
	0;JMP
(XXAAAABI)
	@SP
	M=M+1
	A=M-1
	M=0
	@SP
	AM=M-1
	D=M
	A=A-1
	EQLM
	M=D
	@SP
	AM=M-1
	D=M
	@EVALALT
	!D;JEQ
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	A=D
	MCAR
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@ARG
	A=M
	M=D
	@EVALSTART
	0;JMP
(EVALALT)
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	A=D
	MCDR
	A=D
	MCAR
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@ARG
	A=M
	M=D
	@EVALSTART
	0;JMP
(EVALDEFINE)
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
	@ENV
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	A=D
	MCAR
	@SP
	A=M-1
	M=D
	@EVALEVAL
	D=A
	@R13
	M=D
	@XXAAAABJ
	D=A
	@R15
	M=D
	@SYSCALL
	0;JMP
(XXAAAABJ)
	@SP
	AM=M-1
	D=M
	@FREE
	A=M
	SETCDR
	@SP
	A=M-1
	D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
	A=M-1
	M=D
	@ENV
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
	@ENV
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCDR
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@FREE
	A=M
	SETCDR
	@SP
	A=M-1
	D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@FREE
	A=M
	SETCDR
	@SP
	A=M-1
	D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
	A=M-1
	M=D
	@ENV
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@R7
	M=D
	@SP
	AM=M-1
	D=M
	@R8
	AM=D
	MCDR
	@R7
	A=M
	SETCDR
	@R8
	A=M
	MCAR
	@R7
	A=M
	SETCAR
	@SP
	M=M+1
	A=M-1
	M=0
	@SYSRETURN
	0;JMP
(EVALQUOTE)
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	A=M-1
	A=M
	MCAR
	@SP
	A=M-1
	M=D
	@SYSRETURN
	0;JMP
(EVALSET)
(EVALLAMBDA)
	@ENV
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@ARG
	A=M
	D=M
	@SP
	M=M+1
	A=M-1
	M=D
	@SP
	AM=M-1
	D=M
	@FREE
	A=M
	SETCDR
	@SP
	A=M-1
	D=M
	@FREE
	A=M
	SETCAR
	@FREE
	D=M
	M=D+1
	@SP
	A=M-1
	M=D
	@0x7fff
	D=A
	@0x0001
	D=D+A
	@SP
	A=M-1
	M=D|M
	@SYSRETURN
	0;JMP
